<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Frontline Protocol | Stable Build</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        
        /* HUD */
        #gui { position: absolute; bottom: 30px; left: 30px; color: #00ff00; pointer-events: none; }
        #hp-container { width: 200px; height: 12px; background: rgba(0,0,0,0.5); border: 2px solid #00ff00; }
        #hp-bar { width: 100%; height: 100%; background: #00ff00; transition: width 0.1s; }
        
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 16px; height: 16px;
            border: 2px solid rgba(0, 255, 0, 0.8); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }

        /* Hotbar */
        #hotbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 4px;
        }
        .slot {
            width: 50px; height: 50px; border: 2px solid #444; color: #888;
            display: flex; align-items: center; justify-content: center; font-size: 10px; text-align: center;
        }
        .slot.active { border-color: #00ff00; color: #fff; box-shadow: inset 0 0 10px rgba(0,255,0,0.3); }

        #screen-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none;
        }

        #menu { 
            position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: white;
        }
        button { padding: 12px 40px; background: #00ff00; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="menu">
        <h1>FRONTLINE PROTOCOL</h1>
        <p>STABLE v1.0 | FOREST CHECKPOINT</p>
        <button onclick="lockPointer()">DEPLOY</button>
    </div>

    <div id="screen-flash"></div>
    <div id="crosshair"></div>

    <div id="gui">
        <div style="font-weight: bold; font-size: 12px; margin-bottom: 4px;">OPERATIVE STATUS</div>
        <div id="hp-container"><div id="hp-bar"></div></div>
    </div>

    <div id="hotbar">
        <div id="slot-1" class="slot active">1<br>RIFLE</div>
        <div id="slot-2" class="slot">2<br>TORCH</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- CORE VARIABLES ---
        let health = 100;
        let isSprinting = false;
        let activeSlot = 1;
        const enemies = [];
        const keys = { w: false, a: false, s: false, d: false, shift: false };

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 20, 120);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);

        // --- LIGHTING ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(50, 80, 50);
        sun.castShadow = true;
        scene.add(sun);

        // --- ENVIRONMENT (CHECKPOINT & FOREST) ---
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({ color: 0x445533 }));
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Sandbags (Barrier)
        function addWall(x, z) {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 1.5), new THREE.MeshStandardMaterial({color: 0x887766}));
            wall.position.set(x, 0.5, z);
            scene.add(wall);
        }
        addWall(0, -10); // Center barrier

        // Trees
        for(let i=0; i<60; i++) {
            const tree = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 4), new THREE.MeshStandardMaterial({color: 0x3d2b1f}));
            const leaves = new THREE.Mesh(new THREE.DodecahedronGeometry(2), new THREE.MeshStandardMaterial({color: 0x1e3d1e}));
            leaves.position.y = 3;
            tree.add(trunk, leaves);
            tree.position.set((Math.random()-0.5)*150, 0, (Math.random()-0.5)*150);
            scene.add(tree);
        }

        // --- ENEMIES (HUMAN-LIKE) ---
        function createEnemy() {
            const enemy = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1), new THREE.MeshStandardMaterial({color: 0x222222}));
            body.position.y = 1;
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 1.9;
            enemy.add(body, head);
            enemy.position.set((Math.random()-0.5)*100, 0, (Math.random()-0.5)*100);
            scene.add(enemy);
            enemies.push(enemy);
        }
        for(let i=0; i<15; i++) createEnemy();

        // --- WEAPON & TORCH ---
        const weaponPivot = new THREE.Group();
        const rifle = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.9), new THREE.MeshStandardMaterial({color: 0x111111}));
        rifle.position.set(0.35, -0.35, -0.5);
        
        const torch = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.4), new THREE.MeshStandardMaterial({color: 0x444444}));
        torch.rotation.x = Math.PI / 2;
        torch.position.set(0.35, -0.35, -0.4);
        torch.visible = false;

        const torchLight = new THREE.SpotLight(0xffffff, 0, 40, 0.4);
        camera.add(torchLight, torchLight.target);
        torchLight.target.position.set(0,0,-5);

        weaponPivot.add(rifle, torch);
        camera.add(weaponPivot);
        scene.add(camera);

        // --- EVENT HANDLERS ---
        window.lockPointer = () => controls.lock();
        controls.addEventListener('lock', () => document.getElementById('menu').style.display = 'none');
        controls.addEventListener('unlock', () => document.getElementById('menu').style.display = 'flex');

        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            if(k === 'w') keys.w = true; if(k === 's') keys.s = true;
            if(k === 'a') keys.a = true; if(k === 'd') keys.d = true;
            if(e.shiftKey) isSprinting = true;
            
            if(k === '1') switchItem(1);
            if(k === '2') switchItem(2);
        });
        window.addEventListener('keyup', (e) => {
            const k = e.key.toLowerCase();
            if(k === 'w') keys.w = false; if(k === 's') keys.s = false;
            if(k === 'a') keys.a = false; if(k === 'd') keys.d = false;
            if(!e.shiftKey) isSprinting = false;
        });

        function switchItem(id) {
            activeSlot = id;
            rifle.visible = (id === 1);
            torch.visible = (id === 2);
            torchLight.intensity = (id === 2) ? 80 : 0;
            document.querySelectorAll('.slot').forEach((s, i) => s.className = (i+1 === id) ? 'slot active' : 'slot');
        }

        window.addEventListener('mousedown', () => {
            if(!controls.isLocked || activeSlot !== 1) return;
            // Gun Kickback
            rifle.position.z += 0.08;
            setTimeout(() => rifle.position.z -= 0.08, 50);

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(enemies, true);
            if(hits.length > 0) {
                let hitObj = hits[0].object;
                while(hitObj.parent !== scene) hitObj = hitObj.parent;
                scene.remove(hitObj);
                enemies.splice(enemies.indexOf(hitObj), 1);
            }
        });

        // --- MAIN LOOP ---
        let lastTime = performance.now();
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - lastTime) / 1000;
            lastTime = time;

            if(controls.isLocked) {
                // Movement
                let speed = (isSprinting ? 12 : 6) * delta;
                if(keys.w) controls.moveForward(speed);
                if(keys.s) controls.moveForward(-speed);
                if(keys.a) controls.moveRight(-speed * 0.7);
                if(keys.d) controls.moveRight(speed * 0.7);

                // Gun Bobbing (Smoother)
                if(keys.w || keys.s || keys.a || keys.d) {
                    const bob = isSprinting ? 0.08 : 0.04;
                    weaponPivot.position.y = Math.sin(time * 0.01) * bob;
                    weaponPivot.position.x = Math.cos(time * 0.005) * (bob/2);
                } else {
                    weaponPivot.position.y *= 0.9; // Reset position smoothly
                }

                // Enemy AI
                enemies.forEach(en => {
                    const dist = en.position.distanceTo(camera.position);
                    if(dist < 40) {
                        en.lookAt(camera.position.x, 0, camera.position.z);
                        if(dist > 2) en.translateZ(3 * delta);
                        else {
                            health -= 15 * delta;
                            document.getElementById('hp-bar').style.width = health + "%";
                            document.getElementById('screen-flash').style.opacity = 0.3;
                            setTimeout(() => document.getElementById('screen-flash').style.opacity = 0, 100);
                            if(health <= 0) location.reload();
                        }
                    }
                });
            }
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
