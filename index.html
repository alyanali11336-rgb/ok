<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VANGUARD: ELITE OPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@600&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Rajdhani', sans-serif; }
        canvas { display: block; position: fixed; top: 0; left: 0; z-index: 1; }
        
        #ui-layer { position: absolute; z-index: 100; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
        .lobby-card { background: #111; padding: 40px; border-top: 4px solid #00ffcc; text-align: center; box-shadow: 0 10px 50px #000; }
        
        #hud { position: absolute; bottom: 30px; left: 30px; z-index: 50; display: none; color: #fff; pointer-events: none; }
        .hp-bar { width: 250px; height: 10px; background: rgba(255,255,255,0.1); border: 1px solid #00ffcc; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #00ffcc; box-shadow: 0 0 10px #00ffcc; }
        
        #radar { position: absolute; top: 20px; left: 20px; width: 100px; height: 100px; border: 2px solid #00ffcc; border-radius: 50%; background: rgba(0,255,204,0.1); display: none; }
        #radar-pin { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); }

        #crosshair { position: fixed; top: 50%; left: 50%; width: 16px; height: 16px; border: 1px solid #00ffcc; transform: translate(-50%, -50%) rotate(45deg); z-index: 50; display: none; }
        .btn-deploy { background: #00ffcc; border: none; color: #000; padding: 15px 50px; font-size: 1.5rem; cursor: pointer; font-family: 'Orbitron'; font-weight: bold; }
    </style>
</head>
<body>

    <div id="radar"><div id="radar-pin"></div></div>
    <div id="crosshair"></div>
    
    <div id="hud">
        VANGUARD TACTICAL
        <div class="hp-bar"><div id="hp-fill"></div></div>
    </div>

    <div id="ui-layer">
        <div class="lobby-card">
            <h1 style="color:white; font-family:Orbitron; letter-spacing:10px;">VANGUARD</h1>
            <p style="color:#00ffcc;">SECTOR 7: REINFORCED</p>
            <button class="btn-deploy" id="play-button">DEPLOY</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>

    <script>
        let scene, camera, renderer, gun, clock;
        let isPlaying = false, health = 100;
        let player = { height: 1.8, vY: 0, isJumping: false };
        let bullets = [], enemyBullets = [], enemies = [], collidables = [];
        const keys = {};

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 20, 250);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.rotation.order = 'YXZ';

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // Sunlight
            const sun = new THREE.DirectionalLight(0xffffff, 1.8);
            sun.position.set(50, 100, 50);
            sun.castShadow = true;
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            createEnhancedMap();
            createGun();

            document.getElementById('play-button').onclick = () => document.body.requestPointerLock();
            document.addEventListener('pointerlockchange', () => {
                isPlaying = document.pointerLockElement === document.body;
                document.getElementById('ui-layer').style.display = isPlaying ? 'none' : 'flex';
                document.getElementById('hud').style.display = isPlaying ? 'block' : 'none';
                document.getElementById('radar').style.display = isPlaying ? 'block' : 'none';
                document.getElementById('crosshair').style.display = isPlaying ? 'block' : 'none';
            });

            window.onkeydown = (e) => keys[e.code] = true;
            window.onkeyup = (e) => keys[e.code] = false;
            window.onmousemove = (e) => {
                if(isPlaying) {
                    camera.rotation.y -= e.movementX * 0.002;
                    camera.rotation.x -= e.movementY * 0.002;
                    camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
                }
            };
            window.onmousedown = () => { if(isPlaying) shoot(); };

            animate();
        }

        function createGun() {
            gun = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.8), new THREE.MeshStandardMaterial({color: 0x111111}));
            const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.6), new THREE.MeshStandardMaterial({color: 0x000000}));
            barrel.rotation.x = Math.PI/2; barrel.position.z = -0.5;
            gun.add(body, barrel);
            gun.position.set(0.3, -0.3, -0.6);
            camera.add(gun);
            scene.add(camera);
        }

        function createEnhancedMap() {
            // Ground
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({color: 0x3d4f21}));
            ground.rotation.x = -Math.PI/2; ground.receiveShadow = true;
            scene.add(ground);

            // --- FIXED HOUSE ---
            const house = new THREE.Group();
            const wallMat = new THREE.MeshStandardMaterial({color: 0x7a7a7a});
            const buildWall = (w, h, d, x, y, z) => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), wallMat);
                m.position.set(x, y, z); house.add(m); collidables.push(m);
            };
            // Walls
            buildWall(10, 6, 0.5, 0, 3, -5); buildWall(0.5, 6, 10, -5, 3, 0); 
            buildWall(0.5, 6, 10, 5, 3, 0); buildWall(4, 6, 0.5, -3, 3, 5); buildWall(4, 6, 0.5, 3, 3, 5);
            // FIXED ROOF
            const roof = new THREE.Mesh(new THREE.BoxGeometry(11, 0.5, 11), new THREE.MeshStandardMaterial({color: 0x222222}));
            roof.position.y = 6; house.add(roof); collidables.push(roof);
            
            house.position.set(0, 0, -20);
            scene.add(house);

            // --- FIXED TREES ---
            for(let i=0; i<50; i++) {
                const x = Math.random()*160-80, z = Math.random()*160-80;
                if(Math.abs(x) < 15 && Math.abs(z+20) < 15) continue;
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 8), new THREE.MeshStandardMaterial({color: 0x4b3621}));
                trunk.position.set(x, 4, z);
                const leaves = new THREE.Mesh(new THREE.SphereGeometry(3, 8, 8), new THREE.MeshStandardMaterial({color: 0x1b3022}));
                leaves.position.set(x, 8, z);
                scene.add(trunk, leaves);
                collidables.push(trunk);
            }

            // RED EXPLOSIVE BARRELS
            for(let i=0; i<15; i++) {
                const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 1.5), new THREE.MeshStandardMaterial({color: 0xff0000}));
                barrel.position.set(Math.random()*100-50, 0.75, Math.random()*100-50);
                scene.add(barrel);
                collidables.push(barrel);
            }

            // Enemies
            for(let i=0; i<10; i++) {
                const en = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.5), new THREE.MeshStandardMaterial({color: 0xff4444}));
                en.position.set(Math.random()*100-50, 1.25, Math.random()*100-50);
                scene.add(en);
                enemies.push({mesh: en, lastShot: 0});
            }
        }

        function shoot() {
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({color: 0x00ffcc}));
            b.position.copy(camera.position);
            const dir = new THREE.Vector3(); camera.getWorldDirection(dir);
            bullets.push({mesh: b, dir: dir, time: Date.now()});
            scene.add(b);
            gun.position.z += 0.1;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!isPlaying) return;

            const time = Date.now();
            const oldPos = camera.position.clone();
            const speed = keys['ShiftLeft'] ? 0.22 : 0.12;

            if(keys['KeyW']) camera.translateZ(-speed);
            if(keys['KeyS']) camera.translateZ(speed);
            if(keys['KeyA']) camera.translateX(-speed);
            if(keys['KeyD']) camera.translateX(speed);
            
            // Wall Sliding Collision
            collidables.forEach(obj => {
                if(camera.position.distanceTo(obj.position) < 2.5) camera.position.copy(oldPos);
            });

            // Weapon Bobbing
            const bob = Math.sin(time * 0.005) * 0.01;
            gun.position.y = -0.3 + (keys['KeyW'] ? bob : 0);
            gun.position.z += (-0.6 - gun.position.z) * 0.1;

            // Radar Update
            document.getElementById('radar-pin').style.transform = `translate(-50%, -50%) rotate(${-camera.rotation.y}rad)`;

            // Bullet Logic
            bullets.forEach((b, i) => {
                b.mesh.position.add(b.dir.clone().multiplyScalar(2.5));
                enemies.forEach((en, ei) => {
                    if(b.mesh.position.distanceTo(en.mesh.position) < 2) {
                        scene.remove(en.mesh); enemies.splice(ei, 1);
                    }
                });
            });

            // Enemy AI
            enemies.forEach(en => {
                en.mesh.lookAt(camera.position);
                if(en.mesh.position.distanceTo(camera.position) < 50 && time - en.lastShot > 2000) {
                    const eb = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color: 0xff0000}));
                    eb.position.copy(en.mesh.position);
                    const eDir = new THREE.Vector3().subVectors(camera.position, en.mesh.position).normalize();
                    enemyBullets.push({mesh: eb, dir: eDir});
                    scene.add(eb);
                    en.lastShot = time;
                }
            });

            enemyBullets.forEach((eb, i) => {
                eb.mesh.position.add(eb.dir.clone().multiplyScalar(0.7));
                if(eb.mesh.position.distanceTo(camera.position) < 1.5) {
                    health -= 10;
                    document.getElementById('hp-fill').style.width = health + "%";
                    scene.remove(eb.mesh); enemyBullets.splice(i, 1);
                    if(health <= 0) location.reload();
                }
            });

            renderer.render(scene, camera);
        }
        window.onload = init;
    </script>
</body>
</html>
